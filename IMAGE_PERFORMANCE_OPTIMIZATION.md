# 图像显示性能优化方案

## 目标
- 降低CPU使用率
- 保证图像显示帧率 ≥ 25 FPS
- 优化高分辨率图像处理性能

## 优化方案列表

### 1. **帧率限制和跳帧策略** ⭐⭐⭐⭐⭐
**优先级：最高**
- **问题**：当前即使使用RAF，如果消息频率超过25fps，仍会处理每一帧
- **方案**：
  - 实现帧率限制器（目标25-30fps）
  - 使用时间戳跳帧：只处理最新消息，丢弃中间帧
  - 添加可配置的最大帧率设置
- **预期效果**：减少30-50%的CPU使用

### 2. **图像降采样/缩放** ⭐⭐⭐⭐⭐
**优先级：最高**
- **问题**：处理全分辨率图像（如1920x1080）时CPU消耗大，但显示区域可能较小
- **方案**：
  - 根据显示容器尺寸动态计算目标分辨率
  - 在像素转换前进行降采样（减少像素数量）
  - 添加"质量"设置：高/中/低（对应不同缩放比例）
- **预期效果**：对于大图像，可减少60-80%的像素处理量

### 3. **使用Web Workers进行图像处理** ⭐⭐⭐⭐
**优先级：高**
- **问题**：图像处理在主线程，阻塞UI
- **方案**：
  - 将像素转换逻辑移到Web Worker
  - 使用OffscreenCanvas在Worker中处理
  - 主线程只负责显示结果
- **预期效果**：避免UI阻塞，提升响应性

### 4. **优化像素转换算法** ⭐⭐⭐⭐
**优先级：高**
- **问题**：当前循环中每次计算 `Math.floor(i / width)` 和 `i % width`
- **方案**：
  - 使用双层循环（y, x）替代单层循环，减少计算
  - 使用TypedArray直接内存操作
  - 对于连续内存布局，使用批量复制（如mono8格式）
- **预期效果**：提升20-30%的转换速度

### 5. **使用ImageBitmap替代Canvas** ⭐⭐⭐⭐
**优先级：高**
- **问题**：Canvas的putImageData和toBlob开销较大
- **方案**：
  - 使用ImageBitmap API（更高效）
  - 或使用createImageBitmap从ImageData创建
  - 减少Canvas操作次数
- **预期效果**：减少Canvas相关开销

### 6. **重用ImageData对象** ⭐⭐⭐
**优先级：中**
- **问题**：每次创建新的ImageData对象
- **方案**：
  - 重用ImageData对象，只在尺寸变化时重新创建
  - 使用对象池管理ImageData
- **预期效果**：减少内存分配开销

### 7. **优化Base64解码** ⭐⭐⭐
**优先级：中**
- **问题**：Base64解码可能较慢
- **方案**：
  - 使用更高效的Base64解码库（如base64-js）
  - 或使用浏览器原生API（如果支持）
  - 考虑在服务端直接发送二进制数据
- **预期效果**：减少解码时间

### 8. **延迟处理非可见图像** ⭐⭐⭐
**优先级：中**
- **问题**：即使面板折叠或不可见，仍在处理图像
- **方案**：
  - 使用IntersectionObserver检测可见性
  - 面板折叠时暂停处理
  - 只处理可见的图像面板
- **预期效果**：多面板时显著降低CPU

### 9. **使用requestIdleCallback** ⭐⭐
**优先级：低**
- **问题**：RAF在每帧都执行，即使浏览器忙碌
- **方案**：
  - 对于非关键更新，使用requestIdleCallback
  - 结合RAF和IdleCallback，智能调度
- **预期效果**：在浏览器空闲时处理，减少卡顿

### 10. **图像缓存策略** ⭐⭐
**优先级：低**
- **问题**：相同图像可能重复处理
- **方案**：
  - 基于图像数据hash进行缓存
  - 相同图像直接复用Blob URL
- **预期效果**：减少重复处理

### 11. **使用WebGL进行图像处理** ⭐⭐⭐
**优先级：中高**
- **问题**：CPU处理像素转换较慢
- **方案**：
  - 使用WebGL shader进行像素格式转换
  - GPU加速，性能大幅提升
- **预期效果**：GPU处理，CPU占用极低

### 12. **批量处理优化** ⭐⭐
**优先级：低**
- **问题**：每次只处理一帧
- **方案**：
  - 批量处理多帧（如果队列中有）
  - 只显示最新帧，中间帧跳过
- **预期效果**：减少处理次数

## 推荐实施顺序

### 第一阶段（立即实施，效果显著）：
1. ✅ 帧率限制和跳帧策略
2. ✅ 图像降采样/缩放
3. ✅ 优化像素转换算法

### 第二阶段（进一步优化）：
4. ✅ 使用Web Workers
5. ✅ 使用ImageBitmap
6. ✅ 延迟处理非可见图像

### 第三阶段（高级优化）：
7. ✅ 使用WebGL进行图像处理
8. ✅ 其他优化项

## 预期总体效果

实施第一阶段优化后：
- CPU使用率降低：**50-70%**
- 帧率稳定性：**≥ 25 FPS**
- 大图像（1920x1080）处理时间：**减少60-80%**

实施全部优化后：
- CPU使用率降低：**70-85%**
- 帧率稳定性：**≥ 30 FPS**
- 支持更高分辨率图像实时显示
